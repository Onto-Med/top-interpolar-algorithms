# top-interpolar-algorithms

## Overview

This repository provides a streamlined workflow for executing phenotypic queries using [POLAR](https://www.medizininformatik-initiative.de/en/POLAR) models, which are available at the public demo instance of the [TOP Framework](https://github.com/Onto-Med/top-deployment): <https://top.imise.uni-leipzig.de/polar>.
It leverages the [top-phenotypic-query](https://github.com/Onto-Med/top-phenotypic-query) component to automate querying against the [INTERPOLAR database](https://github.com/medizininformatik-initiative/INTERPOLAR).

> [!TIP]
> This repository includes a Docker-based setup for easy installation and consistent execution, ensuring that users can quickly run queries and obtain results with minimal configuration.

## Phenotype Models

The [models](./models) directory contains the following 15 publicly available POLAR models.
Each model may include several algorithms (composite phenotype definitions) whose details are provided in [algorithms.csv](./algorithms.csv).

- [Acute kidney injury](https://top.imise.uni-leipzig.de/polar/acute_kidney_injury)
- [Anaemia](https://top.imise.uni-leipzig.de/polar/anaemie)
- [Bleeding outside the gastrointestinal tract](https://top.imise.uni-leipzig.de/polar/bleeding_outside_the_gastrointestinal_tract)
- [Bleeding/perforation of the upper gastrointestinal tract](https://top.imise.uni-leipzig.de/polar/blutungen_und_perforationen_des_oberen_git)
- [Decompensated heart failure](https://top.imise.uni-leipzig.de/polar/decompensated_heart_failure)
- [Delirium](https://top.imise.uni-leipzig.de/polar/delir)
- [Exsiccosis/dehydration](https://top.imise.uni-leipzig.de/polar/exsiccosis_dehydration)
- [Fall (injuries)](https://top.imise.uni-leipzig.de/polar/fall__injuries__v2)
- [Hyperkalemia](https://top.imise.uni-leipzig.de/polar/hyperkalaemia)
- [Hypoglycaemia](https://top.imise.uni-leipzig.de/polar/hypoglykaemie)
- [Hypokalemia](https://top.imise.uni-leipzig.de/polar/hypokaliaemie)
- [Hyponatremia](https://top.imise.uni-leipzig.de/polar/hyponatraemia)
- [Hypotension](https://top.imise.uni-leipzig.de/polar/hypotension)
- [Respiratory depression](https://top.imise.uni-leipzig.de/polar/respiratory_depression_a)
- [Syncope and collapse](https://top.imise.uni-leipzig.de/polar/syncope_and_collpase)

## Usage

### Docker (recommended)

For the simplest setup, use the Docker-based workflow.
Ensure [Docker](https://www.docker.com/) is installed on your system before proceeding.

1. Clone this repository.

    ```sh
    git clone https://github.com/Onto-Med/top-interpolar-algorithms.git
    cd top-interpolar-algorithms
    ```

2. Copy `adapter.yml.tpl` and make adjustments to the database connection information.

    ```sh
    cp adapter.yml.tpl adapter.yml

3. Build the Docker image.

    ```sh
    docker build -t top-interpolar-algorithms .
    ```

4. Run the Docker container, mounting the `models` directory and `adapter.yml` file.

    ```sh
    docker run --rm \
        -v ./models:/opt/app/models \
        -v ./adapter.yml:/opt/app/adapter.yml \
        -v ./results:/opt/app/results \
        top-interpolar-algorithms
    ```

### Linux (without Docker)

If you prefer not to use Docker, you can run the workflow directly on a Linux system. Make sure you have Bash and a Java Runtime Environment (JRE) version 21 or higher installed to execute the provided scripts and tools.

<details>
<summary>Instructions for Linux without Docker (click to expand)</summary>

1. Clone this repository.

    ```sh
    git clone https://github.com/Onto-Med/top-interpolar-algorithms.git
    cd top-interpolar-algorithms
    ```

2. Copy `adapter.yml.tpl` and make adjustments to the database connection information.

    ```sh
    cp adapter.yml.tpl adapter.yml
    ```

3. Download the latest `top-phenotypic-query` JAR from the [releases page](https://github.com/Onto-Med/top-phenotypic-query/releases) (replace "x.x.x" with the latest version).

    ```sh
    wget https://github.com/Onto-Med/top-phenotypic-query/releases/download/vx.x.x/top-phenotypic-query-x.x.x-shaded.jar \
        -O top-phenotypic-query.jar
    ```

4. Execute the `run_queries.sh` script.

    ```sh
    ./run_queries.sh
    ```

</details>

## Example Output

The number of matching encounters are printed to STDOUT and query results are stored as ZIP files in `./results`.
You can redirect the output to a file if needed by appending `> results.txt 2>&1` to the `docker run` or `./run_queries.sh` command.

The following example output was generated by running the Docker container against an INTERPOLAR database instance containing the [MII "Kerndatensatz" test data](https://github.com/medizininformatik-initiative/kerndatensatz-testdaten) as of 2025-09-17.
Please note that results may vary if the test dataset changes.

<details>
<summary>Example output (click to expand)</summary>

```txt
No CSV file provided or file does not exist, processing all models in ./models/*.json

Processing model acute_kidney_injury
Algorithm 1: 1
Algorithm 2 : 0
Algorithm 2a: 0
Algorithm 2b: 0
Algorithm 2c: 0

Processing model anaemia
Algorithm 1: 6
Algorithm 1 - CTCAE Grade 1: 6
Algorithm 1 - CTCAE Grade 2: 0
Algorithm 1 - CTCAE Grade 3: 1
Algorithm 2 A: 3
Algorithm 2 B: 5

Processing model bleeding_outside_the_gastrointestinal_tract
Algorithm 1: 2

Processing model bleeding_perforation_upper_gastrointestinal_tract
Algorithm 1: 5

Processing model decompensated_heart_failure
Algorithm 1 A: 14
Algorithm 1 B: 14
Algorithm 2: 11

Processing model delirium
2/3 factors: 7
Basic algorithm A: 1
Basic algorithm B: 1
Extended algorithm: 1

Processing model exsiccosis_dehydration
Algorithm 1: 2

Processing model fall_injuries
Algorithm 1: 22762
Algorithm 2: 22762
Category 4: 5

Processing model hyperkalemia
Algorithm 1 A: 0
Algorithm 1 A - CTCAE Grade 1: 0
Algorithm 1 A - CTCAE Grade 2: 0
Algorithm 1 A - CTCAE Grade 3: 0
Algorithm 1 A - CTCAE Grade 4: 0
Algorithm 1 B: 2
Algorithm 1 B - CTCAE Grade 1: 1
Algorithm 1 B - CTCAE Grade 2: 0
Algorithm 1 B - CTCAE Grade 3: 1
Algorithm 1 B - CTCAE Grade 4: 0
Algorithm 1 C: 0

Processing model hypoglycaemia
Algorithm 1: 2
Algorithm 1  - CTCAE Grade 2: 2
Algorithm 1 - CTCAE Grade 1: 0
Algorithm 1 - CTCAE Grade 3: 0
Algorithm 1 - CTCAE Grade 4: 0
Algorithm 2: 2
Algorithm 3 : 2

Processing model hypokalemia
Algorithm 1 A: 0
Algorithm 1 A - CTCAE Grade 1/2: 0
Algorithm 1 A - CTCAE Grade 3: 0
Algorithm 1 A - CTCAE Grade 4: 0
Algorithm 1 B: 7
Algorithm 1 B - CTCAE Grade 1/2: 7
Algorithm 1 B - CTCAE Grade 3: 0
Algorithm 1 B - CTCAE Grade 4: 0
Algorithm 1 C: 0

Processing model hyponatremia
Algorithm 1 A: 0
Algorithm 1 A - CTCAE Grade 1: 0
Algorithm 1 A - CTCAE Grade 2/3: 0
Algorithm 1 A - CTCAE Grade 4: 0
Algorithm 1 B: 15
Algorithm 1 B - CTCAE Grade 1: 14
Algorithm 1 B - CTCAE Grade 2/3: 1
Algorithm 1 B - CTCAE Grade 4: 0

Processing model hypotension
Algorithm 1: 7181
Algorithm 2: 7181

Processing model respiratory_depression
Algorithm 1 : 0
Algorithm 2 A: 0
Algorithm 2 B: 0

Processing model syncope_and_collapse
Algorithm 1: 0
Algorithm 2 (cardiac syncope): 0
Algorithm 2 A (orthostatic syncope): 0
Algorithm 2 C (vasovagal syncope): 0
Algorithm 2 D (heat syncope): 0
```

</details>

## Advanced Usage

### Custom Models and Algorithms

You can add your own phenotype models by placing their JSON files in the [models](./models) directory.
Models can be exported from the TOP Framework in JSON format.

> [!NOTE]
> By default, all composite phenotype classes with datatype Boolean are considered as algorithms to be executed.
> All models in the [models](./models) directory are searched for such classes.

Alternatively, you can specify a subset of models and algorithms to run using a CSV file.
This file must be provided using the `--csv algorithms.csv` parameter when executing the Docker container or the `run_queries.sh` script.
In case of Docker, use `-v ./algorithms.csv:/opt/app/algorithms.csv` in the Docker command to mount the CSV file containing the desired algorithms.

The format of the CSV file is as follows:

```csv
model,phenotype_id
acute_kidney_injury,e979522c-3850-44c4-b69e-f35a02f38fb1
acute_kidney_injury,ee6954f0-1e05-44d3-8be1-bd450643fe8e
...
```

The `model` column should contain the name of the model (without the `.json` extension), and the `phenotype_id` column should contain the ID of the phenotype class definition to be executed.

### Custom Datasources

This workflow can be adapted to run against other datasources compatible with the TOP Framework.
To do so, modify the `adapter.yml` file to specify the appropriate adapter class and connection details.

For example, to run against an [HL7 FHIR](https://www.hl7.org/fhir/) server, you could use the `care.smith.top.top_phenotypic_query.adapter.fhir.FHIRAdapter` class.

Please refer to the [Data Adapter Configuration Documentation](https://onto-med.github.io/top-deployment/administration/data-adapter-configuration) for more details on available adapters and their configurations.
